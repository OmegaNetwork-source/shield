// STRIX Exploit Framework
// Native exploit modules

export interface Exploit {
    id: string;
    name: string;
    description: string;
    cve?: string;
    cvss?: number;
    severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
    targetService: string;
    targetPort: number[];
    type: 'check' | 'exploit' | 'auxiliary';
    options: ExploitOption[];
    run: (target: string, port: number, options: { [key: string]: any }) => Promise<ExploitResult>;
}

export interface ExploitOption {
    name: string;
    description: string;
    type: 'string' | 'number' | 'boolean';
    required: boolean;
    default?: any;
}

export interface ExploitResult {
    success: boolean;
    vulnerable: boolean;
    message: string;
    data?: any;
    evidence?: string;
    shell?: {
        type: 'reverse' | 'bind' | 'command';
        output?: string;
    };
}

// Vulnerability database - maps services to known vulnerabilities
export const vulnerabilityDatabase: {
    [service: string]: {
        port: number[];
        vulns: {
            id: string;
            name: string;
            cve?: string;
            severity: 'critical' | 'high' | 'medium' | 'low';
            description: string;
            checkFunction?: string;
        }[];
    };
} = {
    'ftp': {
        port: [21],
        vulns: [
            { id: 'FTP-001', name: 'Anonymous FTP Login', severity: 'medium', description: 'FTP server allows anonymous login' },
            { id: 'FTP-002', name: 'FTP Bounce Attack', severity: 'medium', description: 'FTP server vulnerable to bounce attack' },
            { id: 'FTP-003', name: 'ProFTPD mod_copy', cve: 'CVE-2015-3306', severity: 'critical', description: 'ProFTPD mod_copy allows remote code execution' },
            { id: 'FTP-004', name: 'vsftpd Backdoor', cve: 'CVE-2011-2523', severity: 'critical', description: 'vsftpd 2.3.4 contains a backdoor' }
        ]
    },
    'ssh': {
        port: [22],
        vulns: [
            { id: 'SSH-001', name: 'SSH Weak Password', severity: 'high', description: 'SSH server accepts weak/default passwords' },
            { id: 'SSH-002', name: 'SSH User Enumeration', cve: 'CVE-2018-15473', severity: 'medium', description: 'OpenSSH user enumeration vulnerability' },
            { id: 'SSH-003', name: 'libssh Auth Bypass', cve: 'CVE-2018-10933', severity: 'critical', description: 'libssh authentication bypass' }
        ]
    },
    'telnet': {
        port: [23],
        vulns: [
            { id: 'TEL-001', name: 'Telnet Clear Text', severity: 'high', description: 'Telnet transmits credentials in clear text' },
            { id: 'TEL-002', name: 'Default Credentials', severity: 'critical', description: 'Device uses default telnet credentials' }
        ]
    },
    'smtp': {
        port: [25, 587],
        vulns: [
            { id: 'SMTP-001', name: 'Open Relay', severity: 'high', description: 'SMTP server is an open relay' },
            { id: 'SMTP-002', name: 'VRFY Enumeration', severity: 'low', description: 'SMTP VRFY command allows user enumeration' }
        ]
    },
    'http': {
        port: [80, 8080, 8000, 8008],
        vulns: [
            { id: 'HTTP-001', name: 'Directory Listing', severity: 'low', description: 'Web server exposes directory listing' },
            { id: 'HTTP-002', name: 'Shellshock', cve: 'CVE-2014-6271', severity: 'critical', description: 'Bash Shellshock vulnerability via CGI' },
            { id: 'HTTP-003', name: 'Apache Struts RCE', cve: 'CVE-2017-5638', severity: 'critical', description: 'Apache Struts remote code execution' },
            { id: 'HTTP-004', name: 'PHP Info Disclosure', severity: 'low', description: 'PHP info page exposed' },
            { id: 'HTTP-005', name: 'Default Credentials', severity: 'high', description: 'Web application uses default credentials' }
        ]
    },
    'https': {
        port: [443, 8443],
        vulns: [
            { id: 'TLS-001', name: 'Heartbleed', cve: 'CVE-2014-0160', severity: 'critical', description: 'OpenSSL Heartbleed vulnerability' },
            { id: 'TLS-002', name: 'POODLE', cve: 'CVE-2014-3566', severity: 'medium', description: 'SSLv3 POODLE vulnerability' },
            { id: 'TLS-003', name: 'ROBOT', cve: 'CVE-2017-13099', severity: 'medium', description: 'ROBOT TLS vulnerability' }
        ]
    },
    'smb': {
        port: [139, 445],
        vulns: [
            { id: 'SMB-001', name: 'MS17-010 EternalBlue', cve: 'CVE-2017-0144', severity: 'critical', description: 'SMB remote code execution (WannaCry)' },
            { id: 'SMB-002', name: 'MS08-067', cve: 'CVE-2008-4250', severity: 'critical', description: 'Windows Server Service RCE' },
            { id: 'SMB-003', name: 'Null Session', severity: 'medium', description: 'SMB allows null session connections' },
            { id: 'SMB-004', name: 'SMBGhost', cve: 'CVE-2020-0796', severity: 'critical', description: 'SMBv3 compression RCE' },
            { id: 'SMB-005', name: 'SMB Signing Disabled', severity: 'medium', description: 'SMB signing not required' }
        ]
    },
    'mysql': {
        port: [3306],
        vulns: [
            { id: 'MYSQL-001', name: 'Root No Password', severity: 'critical', description: 'MySQL root has no password' },
            { id: 'MYSQL-002', name: 'Auth Bypass', cve: 'CVE-2012-2122', severity: 'critical', description: 'MySQL authentication bypass' }
        ]
    },
    'mssql': {
        port: [1433],
        vulns: [
            { id: 'MSSQL-001', name: 'SA Default Password', severity: 'critical', description: 'MSSQL SA account has weak password' },
            { id: 'MSSQL-002', name: 'xp_cmdshell Enabled', severity: 'high', description: 'MSSQL xp_cmdshell is enabled' }
        ]
    },
    'rdp': {
        port: [3389],
        vulns: [
            { id: 'RDP-001', name: 'BlueKeep', cve: 'CVE-2019-0708', severity: 'critical', description: 'RDP remote code execution' },
            { id: 'RDP-002', name: 'NLA Disabled', severity: 'medium', description: 'Network Level Authentication disabled' },
            { id: 'RDP-003', name: 'Weak Encryption', severity: 'medium', description: 'RDP uses weak encryption' }
        ]
    },
    'vnc': {
        port: [5900, 5901, 5902],
        vulns: [
            { id: 'VNC-001', name: 'No Authentication', severity: 'critical', description: 'VNC server requires no authentication' },
            { id: 'VNC-002', name: 'Weak Password', severity: 'high', description: 'VNC uses weak/default password' }
        ]
    },
    'redis': {
        port: [6379],
        vulns: [
            { id: 'REDIS-001', name: 'No Authentication', severity: 'critical', description: 'Redis server has no authentication' },
            { id: 'REDIS-002', name: 'Lua Sandbox Escape', cve: 'CVE-2022-0543', severity: 'critical', description: 'Redis Lua sandbox escape' }
        ]
    },
    'mongodb': {
        port: [27017],
        vulns: [
            { id: 'MONGO-001', name: 'No Authentication', severity: 'critical', description: 'MongoDB has no authentication' }
        ]
    }
};

// Get vulnerabilities for a service/port
export function getVulnerabilitiesForPort(port: number): typeof vulnerabilityDatabase[string]['vulns'] {
    const vulns: typeof vulnerabilityDatabase[string]['vulns'] = [];
    
    for (const [service, data] of Object.entries(vulnerabilityDatabase)) {
        if (data.port.includes(port)) {
            vulns.push(...data.vulns);
        }
    }
    
    return vulns;
}

// Get service name from port
export function getServiceFromPort(port: number): string {
    for (const [service, data] of Object.entries(vulnerabilityDatabase)) {
        if (data.port.includes(port)) {
            return service;
        }
    }
    return 'unknown';
}

export default {
    vulnerabilityDatabase,
    getVulnerabilitiesForPort,
    getServiceFromPort
};
