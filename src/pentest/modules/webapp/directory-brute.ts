// STRIX Directory/File Bruteforcer Module
// Like gobuster/dirbuster - discovers hidden files and directories

import * as http from 'http';
import * as https from 'https';
import { VulnerabilityResult, ModuleInfo, ModuleResult, ProgressCallback } from '../../types';

export const moduleInfo: ModuleInfo = {
    name: 'directory_brute',
    displayName: 'Directory/File Bruteforcer',
    description: 'Discovers hidden files and directories through wordlist-based enumeration',
    author: 'STRIX',
    version: '1.0.0',
    type: 'scanner',
    targetService: 'http',
    options: [
        { name: 'target', type: 'string', required: true, description: 'Target URL (e.g., http://example.com)' },
        { name: 'wordlist', type: 'select', required: false, default: 'common', description: 'Wordlist to use', choices: ['common', 'small', 'medium', 'large', 'api'] },
        { name: 'extensions', type: 'string', required: false, default: '', description: 'File extensions to append (comma-separated, e.g., php,html,txt)' },
        { name: 'threads', type: 'number', required: false, default: 10, description: 'Number of concurrent requests' },
        { name: 'timeout', type: 'number', required: false, default: 5000, description: 'Request timeout in ms' },
        { name: 'followRedirects', type: 'boolean', required: false, default: false, description: 'Follow redirects' },
        { name: 'statusCodes', type: 'string', required: false, default: '200,204,301,302,307,401,403', description: 'Status codes to report' }
    ]
};

// Common wordlists for directory bruteforcing
export const WORDLISTS = {
    small: [
        'admin', 'login', 'wp-admin', 'administrator', 'backup', 'test',
        'dev', 'api', 'config', 'dashboard', 'panel', 'portal'
    ],
    common: [
        'admin', 'administrator', 'login', 'wp-admin', 'wp-login', 'wp-content',
        'backup', 'backups', 'bak', 'test', 'testing', 'dev', 'development',
        'api', 'v1', 'v2', 'config', 'configuration', 'settings', 'setup',
        'install', 'dashboard', 'panel', 'cpanel', 'admin-panel', 'adminpanel',
        'portal', 'user', 'users', 'account', 'accounts', 'member', 'members',
        'private', 'public', 'uploads', 'upload', 'files', 'file', 'data',
        'database', 'db', 'sql', 'mysql', 'phpmyadmin', 'pma', 'adminer',
        'console', 'terminal', 'shell', 'cmd', 'manager', 'management',
        'secure', 'security', 'auth', 'authentication', 'oauth', 'sso',
        'assets', 'static', 'media', 'images', 'img', 'css', 'js', 'scripts',
        'includes', 'inc', 'lib', 'library', 'vendor', 'node_modules',
        'temp', 'tmp', 'cache', 'log', 'logs', 'error', 'errors', 'debug',
        '.git', '.svn', '.env', '.htaccess', '.htpasswd', 'robots.txt',
        'sitemap.xml', 'web.config', 'crossdomain.xml', 'clientaccesspolicy.xml',
        'phpinfo.php', 'info.php', 'test.php', 'index.php', 'index.html',
        'home', 'main', 'default', 'root', 'server-status', 'server-info',
        'old', 'new', 'archive', 'archives', 'download', 'downloads'
    ],
    medium: [
        // All of common plus more
        'admin', 'administrator', 'login', 'wp-admin', 'wp-login', 'wp-content', 'wp-includes',
        'backup', 'backups', 'bak', 'old', 'new', 'test', 'testing', 'dev', 'development', 'staging',
        'api', 'v1', 'v2', 'v3', 'rest', 'graphql', 'swagger', 'docs', 'documentation',
        'config', 'configuration', 'settings', 'setup', 'install', 'installer',
        'dashboard', 'panel', 'cpanel', 'admin-panel', 'adminpanel', 'control',
        'portal', 'user', 'users', 'account', 'accounts', 'member', 'members', 'profile', 'profiles',
        'private', 'public', 'uploads', 'upload', 'files', 'file', 'data', 'assets',
        'database', 'db', 'sql', 'mysql', 'postgres', 'mongo', 'redis',
        'phpmyadmin', 'pma', 'adminer', 'pgadmin', 'webmail', 'mail', 'email',
        'console', 'terminal', 'shell', 'cmd', 'manager', 'management', 'cms',
        'blog', 'news', 'article', 'articles', 'post', 'posts', 'page', 'pages',
        'product', 'products', 'shop', 'store', 'cart', 'checkout', 'payment',
        'order', 'orders', 'invoice', 'invoices', 'customer', 'customers',
        'report', 'reports', 'analytics', 'stats', 'statistics', 'metrics',
        'help', 'support', 'faq', 'contact', 'about', 'info', 'information',
        'service', 'services', 'app', 'application', 'mobile', 'android', 'ios',
        'cron', 'job', 'jobs', 'task', 'tasks', 'queue', 'worker', 'workers',
        'health', 'healthcheck', 'ping', 'status', 'version', 'build', 'release',
        'internal', 'external', 'intranet', 'extranet', 'partner', 'partners',
        'vendor', 'vendors', 'supplier', 'suppliers', 'client', 'clients',
        'demo', 'sample', 'example', 'examples', 'template', 'templates',
        'theme', 'themes', 'plugin', 'plugins', 'module', 'modules', 'component', 'components',
        'font', 'fonts', 'icon', 'icons', 'image', 'images', 'img', 'pic', 'pics', 'photo', 'photos',
        'video', 'videos', 'audio', 'music', 'sound', 'sounds', 'document', 'documents',
        'pdf', 'doc', 'xls', 'ppt', 'txt', 'xml', 'json', 'yaml', 'yml',
        'error', 'errors', '404', '500', 'error_log', 'debug', 'trace', 'log', 'logs',
        'temp', 'tmp', 'cache', 'cached', 'session', 'sessions', 'cookie', 'cookies',
        '.git', '.svn', '.hg', '.bzr', '.env', '.env.local', '.env.production',
        '.htaccess', '.htpasswd', '.DS_Store', 'Thumbs.db', 'desktop.ini',
        'robots.txt', 'sitemap.xml', 'sitemap_index.xml', 'rss', 'feed', 'atom',
        'web.config', 'crossdomain.xml', 'clientaccesspolicy.xml', 'browserconfig.xml',
        'manifest.json', 'package.json', 'composer.json', 'Gemfile', 'requirements.txt',
        'Dockerfile', 'docker-compose.yml', '.dockerignore', 'Vagrantfile', 'Makefile',
        'README', 'README.md', 'README.txt', 'CHANGELOG', 'LICENSE', 'TODO',
        'phpinfo', 'info', 'test', 'debug', 'trace', 'server-status', 'server-info',
        'jmx-console', 'web-console', 'invoker', 'manager/html', 'admin/config.php',
        'fckeditor', 'ckeditor', 'tinymce', 'editor', 'filemanager', 'elfinder'
    ],
    large: [], // Would include thousands - for now reference medium
    api: [
        'api', 'v1', 'v2', 'v3', 'rest', 'graphql', 'query', 'mutation',
        'auth', 'login', 'logout', 'register', 'signup', 'signin', 'token', 'refresh',
        'user', 'users', 'me', 'profile', 'account', 'accounts', 'settings',
        'admin', 'administrator', 'moderator', 'role', 'roles', 'permission', 'permissions',
        'product', 'products', 'item', 'items', 'catalog', 'category', 'categories',
        'order', 'orders', 'cart', 'checkout', 'payment', 'payments', 'transaction', 'transactions',
        'customer', 'customers', 'client', 'clients', 'member', 'members',
        'post', 'posts', 'article', 'articles', 'comment', 'comments', 'reply', 'replies',
        'message', 'messages', 'notification', 'notifications', 'alert', 'alerts',
        'file', 'files', 'upload', 'uploads', 'download', 'downloads', 'media',
        'image', 'images', 'photo', 'photos', 'video', 'videos', 'document', 'documents',
        'search', 'filter', 'sort', 'page', 'limit', 'offset', 'cursor',
        'health', 'healthcheck', 'ping', 'status', 'version', 'info', 'metrics',
        'webhook', 'webhooks', 'callback', 'callbacks', 'event', 'events',
        'config', 'configuration', 'setting', 'settings', 'preference', 'preferences',
        'log', 'logs', 'audit', 'history', 'activity', 'activities',
        'report', 'reports', 'analytics', 'stats', 'statistics', 'dashboard',
        'export', 'import', 'sync', 'batch', 'bulk', 'job', 'jobs', 'task', 'tasks',
        'internal', 'private', 'public', 'external', 'debug', 'test', 'dev',
        '.json', '.xml', '.yaml', '/swagger', '/openapi', '/docs', '/redoc'
    ]
};

// Initialize large wordlist
WORDLISTS.large = [...WORDLISTS.medium,
    // Additional paths for comprehensive scanning
    'adm', 'admin2', 'admin_area', 'admin_login', 'adminarea', 'adminLogin', 'admin_login.asp',
    'administratorlogin', 'asp', 'aspx', 'bitrix', 'cfg', 'cgi', 'cgi-bin', 'cgi-local',
    'conf', 'connect', 'content', 'control', 'controlpanel', 'cp', 'cpadmin', 'crm',
    'customer', 'db_admin', 'dbadmin', 'debug', 'default', 'dir', 'directory', 'docs',
    'editor', 'fcgi', 'forum', 'forums', 'git', 'global', 'guest', 'home', 'htm',
    'iisadmin', 'include', 'includes', 'intranet', 'java', 'joomla', 'jsp', 'lib',
    'libraries', 'locale', 'login', 'magento', 'manage', 'management', 'manual',
    'memcached', 'misc', 'modules', 'monitor', 'myadmin', 'mysql-admin', 'mysqladmin',
    'net', 'network', 'office', 'old_site', 'oldsite', 'openapi', 'oracle', 'panel',
    'pass', 'passwd', 'password', 'path', 'perl', 'pgsql', 'php', 'php-my-admin',
    'php-myadmin', 'php_myadmin', 'php_phpmyadmin', 'phpldapadmin', 'phpmyadmin',
    'phpmyadmin2', 'phpMyAdmin-2', 'phpPgAdmin', 'phppgadmin', 'phpSysInfo', 'pls',
    'plus', 'projects', 'readme', 'root', 'roundcube', 'roundcubemail', 'rpc', 'run',
    'scripts', 'secret', 'secrets', 'secure', 'siteadmin', 'sitemanager', 'sites',
    'sitecore', 'sql', 'sqladmin', 'sqlmanager', 'sqlweb', 'ssl', 'stat', 'statistics',
    'storage', 'store', 'support', 'svn', 'sys', 'sysadmin', 'sysadmins', 'system',
    'templates', 'test', 'text', 'tmp', 'tools', 'typo3', 'update', 'uri', 'user',
    'userfiles', 'usr', 'utility', 'var', 'vb', 'vbscript', 'viewer', 'web', 'webadmin',
    'weblog', 'webmaster', 'website', 'wordpress', 'work', 'wp', 'wpadmin', 'wstat',
    'wwwroot', 'wwwstat', 'xhtml', 'xmlrpc', 'xsql'
];

export interface BruteResult {
    path: string;
    url: string;
    statusCode: number;
    contentLength: number;
    contentType?: string;
    redirect?: string;
}

export interface DirectoryBruteResult extends ModuleResult {
    data: {
        found: BruteResult[];
        scanned: number;
        duration: number;
        interestingFinds: BruteResult[];
    };
}

/**
 * Run directory bruteforce scan
 */
export async function run(
    target: string,
    options: {
        wordlist?: keyof typeof WORDLISTS;
        extensions?: string;
        threads?: number;
        timeout?: number;
        followRedirects?: boolean;
        statusCodes?: string;
        customWordlist?: string[];
        onProgress?: ProgressCallback;
    } = {}
): Promise<DirectoryBruteResult> {
    const startTime = Date.now();
    const wordlistName = options.wordlist || 'common';
    const extensions = options.extensions ? options.extensions.split(',').map(e => e.trim()) : [];
    const threads = options.threads || 10;
    const timeout = options.timeout || 5000;
    const validCodes = (options.statusCodes || '200,204,301,302,307,401,403')
        .split(',')
        .map(c => parseInt(c.trim()));

    const result: DirectoryBruteResult = {
        success: false,
        module: 'directory_brute',
        target,
        data: {
            found: [],
            scanned: 0,
            duration: 0,
            interestingFinds: []
        },
        vulnerabilities: [],
        duration: 0
    };

    try {
        // Parse target URL
        const url = new URL(target);
        const useSSL = url.protocol === 'https:';
        const host = url.hostname;
        const port = url.port ? parseInt(url.port) : (useSSL ? 443 : 80);
        const basePath = url.pathname.endsWith('/') ? url.pathname : url.pathname + '/';

        // Build path list
        const wordlist = options.customWordlist || WORDLISTS[wordlistName];
        const paths: string[] = [];

        for (const word of wordlist) {
            paths.push(word);
            // Add extensions
            for (const ext of extensions) {
                paths.push(`${word}.${ext}`);
            }
        }

        const total = paths.length;
        const found: BruteResult[] = [];

        // Process in batches
        for (let i = 0; i < paths.length; i += threads) {
            const batch = paths.slice(i, i + threads);
            const batchResults = await Promise.all(
                batch.map(path => checkPath(host, port, useSSL, basePath + path, timeout, options.followRedirects))
            );

            for (let j = 0; j < batchResults.length; j++) {
                const res = batchResults[j];
                if (res && validCodes.includes(res.statusCode)) {
                    res.path = batch[j];
                    res.url = `${url.protocol}//${host}${port !== (useSSL ? 443 : 80) ? ':' + port : ''}${basePath}${batch[j]}`;
                    found.push(res);
                }
            }

            result.data.scanned = Math.min(i + threads, total);

            if (options.onProgress) {
                options.onProgress({
                    phase: 'bruteforce',
                    current: result.data.scanned,
                    total,
                    message: `Scanning: ${result.data.scanned}/${total} paths, ${found.length} found`
                });
            }
        }

        result.data.found = found;
        result.success = true;

        // Identify interesting findings
        const interestingPatterns = [
            /admin/i, /backup/i, /\.git/i, /\.env/i, /config/i, /database/i,
            /phpinfo/i, /phpmyadmin/i, /\.sql/i, /\.bak/i, /password/i,
            /secret/i, /private/i, /internal/i, /debug/i, /test/i, /staging/i
        ];

        result.data.interestingFinds = found.filter(f => 
            interestingPatterns.some(p => p.test(f.path)) || f.statusCode === 200
        );

        // Generate vulnerabilities for critical findings
        for (const item of result.data.interestingFinds) {
            if (/\.git/i.test(item.path)) {
                result.vulnerabilities!.push({
                    id: 'DIR-001',
                    name: 'Git Repository Exposed',
                    severity: 'critical',
                    description: `Git repository found at ${item.url}`,
                    evidence: `Status: ${item.statusCode}`,
                    remediation: 'Remove .git folder from web root or block access via web server config.',
                    host: target,
                    service: 'http'
                });
            } else if (/\.env/i.test(item.path) && item.statusCode === 200) {
                result.vulnerabilities!.push({
                    id: 'DIR-002',
                    name: 'Environment File Exposed',
                    severity: 'critical',
                    description: `.env file accessible at ${item.url}`,
                    evidence: `Status: ${item.statusCode}`,
                    remediation: 'Remove .env files from web root or block access.',
                    host: target,
                    service: 'http'
                });
            } else if (/backup|\.bak|\.sql/i.test(item.path) && item.statusCode === 200) {
                result.vulnerabilities!.push({
                    id: 'DIR-003',
                    name: 'Backup/Database File Exposed',
                    severity: 'high',
                    description: `Potential backup file found at ${item.url}`,
                    evidence: `Status: ${item.statusCode}`,
                    remediation: 'Remove backup files from web root.',
                    host: target,
                    service: 'http'
                });
            } else if (/phpinfo|info\.php/i.test(item.path) && item.statusCode === 200) {
                result.vulnerabilities!.push({
                    id: 'DIR-004',
                    name: 'PHP Info Page Exposed',
                    severity: 'medium',
                    description: `phpinfo() page accessible at ${item.url}`,
                    evidence: `Status: ${item.statusCode}`,
                    remediation: 'Remove phpinfo files from production servers.',
                    host: target,
                    service: 'http'
                });
            } else if (/admin|dashboard|panel/i.test(item.path) && item.statusCode === 200) {
                result.vulnerabilities!.push({
                    id: 'DIR-005',
                    name: 'Admin Panel Discovered',
                    severity: 'info',
                    description: `Potential admin interface at ${item.url}`,
                    evidence: `Status: ${item.statusCode}`,
                    remediation: 'Ensure admin panels are properly secured and access-controlled.',
                    host: target,
                    service: 'http'
                });
            }
        }

    } catch (err: any) {
        result.error = err.message;
    }

    result.duration = Date.now() - startTime;
    result.data.duration = result.duration;
    return result;
}

/**
 * Check if a path exists
 */
async function checkPath(
    host: string,
    port: number,
    ssl: boolean,
    path: string,
    timeout: number,
    followRedirects?: boolean
): Promise<BruteResult | null> {
    return new Promise((resolve) => {
        const options = {
            hostname: host,
            port,
            path,
            method: 'GET',
            timeout,
            rejectUnauthorized: false,
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': '*/*'
            }
        };

        const protocol = ssl ? https : http;

        const req = protocol.request(options, (res) => {
            // Consume response body
            res.on('data', () => {});
            res.on('end', () => {
                const result: BruteResult = {
                    path: '',
                    url: '',
                    statusCode: res.statusCode || 0,
                    contentLength: parseInt(res.headers['content-length'] || '0'),
                    contentType: res.headers['content-type']
                };

                if (res.headers.location) {
                    result.redirect = res.headers.location;
                }

                resolve(result);
            });
        });

        req.on('timeout', () => {
            req.destroy();
            resolve(null);
        });

        req.on('error', () => {
            resolve(null);
        });

        req.end();
    });
}

export default { run, moduleInfo, WORDLISTS };
