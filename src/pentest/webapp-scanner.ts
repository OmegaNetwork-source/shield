// STRIX Web Application Scanner
// Combines all web app testing modules for comprehensive scans

import { VulnerabilityResult, ModuleResult, ProgressCallback } from './types';
import * as dirbuster from './modules/dirbuster';
import * as sqli from './modules/sqli';
import * as xss from './modules/xss';
import * as headers from './modules/headers';
import * as subdomainTakeover from './modules/subdomain-takeover';

export interface WebAppScanOptions {
    // General options
    timeout?: number;
    
    // Module selection
    skipDirbuster?: boolean;
    skipSQLi?: boolean;
    skipXSS?: boolean;
    skipHeaders?: boolean;
    skipSubdomainTakeover?: boolean;
    
    // Dirbuster options
    dirbusterWordlist?: 'small' | 'common' | 'large';
    dirbusterExtensions?: string[];
    dirbusterThreads?: number;
    
    // SQLi options
    sqliAggressive?: boolean;
    
    // XSS options
    xssCheckDOM?: boolean;
    
    // Subdomain takeover options
    subdomainWordlist?: 'minimal' | 'common' | 'large';
    
    // Progress callback
    onProgress?: ProgressCallback;
}

export interface WebAppScanResult {
    target: string;
    startTime: Date;
    endTime: Date;
    duration: number;
    
    // Individual results
    headersResult?: headers.HeadersScanResult;
    dirbusterResult?: dirbuster.DirBustScanResult;
    sqliResult?: sqli.SQLiScanResult;
    xssResult?: xss.XSSScanResult;
    subdomainResult?: subdomainTakeover.SubdomainTakeoverScanResult;
    
    // Aggregated vulnerabilities
    vulnerabilities: VulnerabilityResult[];
    
    // Summary
    summary: {
        total: number;
        critical: number;
        high: number;
        medium: number;
        low: number;
        info: number;
    };
}

/**
 * Run comprehensive web application scan
 */
export async function scanWebApp(
    target: string,
    options: WebAppScanOptions = {}
): Promise<WebAppScanResult> {
    const startTime = new Date();
    const timeout = options.timeout || 10000;
    
    const result: WebAppScanResult = {
        target,
        startTime,
        endTime: new Date(),
        duration: 0,
        vulnerabilities: [],
        summary: {
            total: 0,
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            info: 0
        }
    };
    
    // Parse URL for domain extraction
    let targetUrl: URL;
    try {
        targetUrl = new URL(target);
    } catch {
        targetUrl = new URL(`https://${target}`);
    }
    
    const domain = targetUrl.hostname;
    const phases = [];
    
    // Determine which phases to run
    if (!options.skipHeaders) phases.push('headers');
    if (!options.skipDirbuster) phases.push('dirbuster');
    if (!options.skipSQLi) phases.push('sqli');
    if (!options.skipXSS) phases.push('xss');
    if (!options.skipSubdomainTakeover) phases.push('subdomain');
    
    let currentPhase = 0;
    
    const updateProgress = (phase: string, current: number, total: number, message: string) => {
        if (options.onProgress) {
            options.onProgress({
                phase,
                current,
                total,
                message: `[${currentPhase + 1}/${phases.length}] ${message}`
            });
        }
    };
    
    // 1. Security Headers Analysis
    if (!options.skipHeaders) {
        updateProgress('headers', 0, 1, 'Analyzing security headers...');
        
        result.headersResult = await headers.run(target, { timeout });
        
        if (result.headersResult.vulnerabilities) {
            result.vulnerabilities.push(...result.headersResult.vulnerabilities);
        }
        
        currentPhase++;
    }
    
    // 2. Directory Bruteforce
    if (!options.skipDirbuster) {
        result.dirbusterResult = await dirbuster.run(target, {
            wordlist: options.dirbusterWordlist || 'common',
            extensions: options.dirbusterExtensions,
            threads: options.dirbusterThreads || 10,
            timeout,
            onProgress: (progress) => updateProgress('dirbuster', progress.current, progress.total, progress.message)
        });
        
        if (result.dirbusterResult.vulnerabilities) {
            result.vulnerabilities.push(...result.dirbusterResult.vulnerabilities);
        }
        
        currentPhase++;
    }
    
    // 3. SQL Injection Testing
    if (!options.skipSQLi) {
        // Only run if URL has parameters
        if (targetUrl.search || target.includes('?')) {
            result.sqliResult = await sqli.run(target, {
                timeout,
                aggressive: options.sqliAggressive,
                onProgress: (progress) => updateProgress('sqli', progress.current, progress.total, progress.message)
            });
            
            if (result.sqliResult.vulnerabilities) {
                result.vulnerabilities.push(...result.sqliResult.vulnerabilities);
            }
        }
        
        currentPhase++;
    }
    
    // 4. XSS Testing
    if (!options.skipXSS) {
        result.xssResult = await xss.run(target, {
            timeout,
            checkDOM: options.xssCheckDOM !== false,
            onProgress: (progress) => updateProgress('xss', progress.current, progress.total, progress.message)
        });
        
        if (result.xssResult.vulnerabilities) {
            result.vulnerabilities.push(...result.xssResult.vulnerabilities);
        }
        
        currentPhase++;
    }
    
    // 5. Subdomain Takeover Check
    if (!options.skipSubdomainTakeover) {
        result.subdomainResult = await subdomainTakeover.run(domain, {
            wordlist: options.subdomainWordlist || 'minimal',
            timeout,
            checkHTTP: true,
            onProgress: (progress) => updateProgress('subdomain', progress.current, progress.total, progress.message)
        });
        
        if (result.subdomainResult.vulnerabilities) {
            result.vulnerabilities.push(...result.subdomainResult.vulnerabilities);
        }
        
        currentPhase++;
    }
    
    // Calculate summary
    result.summary.total = result.vulnerabilities.length;
    for (const vuln of result.vulnerabilities) {
        switch (vuln.severity) {
            case 'critical': result.summary.critical++; break;
            case 'high': result.summary.high++; break;
            case 'medium': result.summary.medium++; break;
            case 'low': result.summary.low++; break;
            case 'info': result.summary.info++; break;
        }
    }
    
    result.endTime = new Date();
    result.duration = result.endTime.getTime() - startTime.getTime();
    
    return result;
}

/**
 * Quick web app scan - headers and basic checks only
 */
export async function quickWebAppScan(
    target: string,
    options: WebAppScanOptions = {}
): Promise<WebAppScanResult> {
    return scanWebApp(target, {
        ...options,
        skipDirbuster: true,
        skipSubdomainTakeover: true,
        dirbusterWordlist: 'small',
        subdomainWordlist: 'minimal'
    });
}

/**
 * Full web app scan - all modules with thorough settings
 */
export async function fullWebAppScan(
    target: string,
    options: WebAppScanOptions = {}
): Promise<WebAppScanResult> {
    return scanWebApp(target, {
        ...options,
        dirbusterWordlist: 'large',
        sqliAggressive: true,
        xssCheckDOM: true,
        subdomainWordlist: 'common'
    });
}

/**
 * Generate HTML report from scan results
 */
export function generateReport(result: WebAppScanResult): string {
    const severityColors: { [key: string]: string } = {
        critical: '#dc2626',
        high: '#ea580c',
        medium: '#ca8a04',
        low: '#2563eb',
        info: '#6b7280'
    };
    
    const vulnerabilitiesHTML = result.vulnerabilities
        .sort((a, b) => {
            const order = ['critical', 'high', 'medium', 'low', 'info'];
            return order.indexOf(a.severity) - order.indexOf(b.severity);
        })
        .map(v => `
            <div class="vulnerability" style="border-left: 4px solid ${severityColors[v.severity]}; padding: 12px; margin: 8px 0; background: #f9fafb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>${escapeHtml(v.name)}</strong>
                    <span style="background: ${severityColors[v.severity]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase;">
                        ${v.severity}
                    </span>
                </div>
                <p style="margin: 8px 0;">${escapeHtml(v.description)}</p>
                ${v.evidence ? `<pre style="background: #e5e7eb; padding: 8px; overflow-x: auto; font-size: 12px;">${escapeHtml(v.evidence)}</pre>` : ''}
                ${v.remediation ? `<p style="margin-top: 8px;"><strong>Remediation:</strong> ${escapeHtml(v.remediation)}</p>` : ''}
                <p style="font-size: 12px; color: #6b7280;">Host: ${v.host}${v.port ? `:${v.port}` : ''} | ID: ${v.id}</p>
            </div>
        `)
        .join('');
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Web Application Security Scan Report - ${escapeHtml(result.target)}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f3f4f6; }
        .header { background: linear-gradient(135deg, #1e3a5f, #0f172a); color: white; padding: 24px; border-radius: 8px; margin-bottom: 20px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .summary-card { background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .summary-card h3 { margin: 0; font-size: 32px; }
        .summary-card p { margin: 4px 0 0; color: #6b7280; }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section h2 { margin-top: 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin: 0;">Web Application Security Scan Report</h1>
        <p style="margin: 8px 0 0; opacity: 0.8;">Target: ${escapeHtml(result.target)}</p>
        <p style="margin: 4px 0 0; opacity: 0.8;">Scan Date: ${result.startTime.toISOString()} | Duration: ${(result.duration / 1000).toFixed(1)}s</p>
    </div>
    
    <div class="summary">
        <div class="summary-card">
            <h3 style="color: ${severityColors.critical}">${result.summary.critical}</h3>
            <p>Critical</p>
        </div>
        <div class="summary-card">
            <h3 style="color: ${severityColors.high}">${result.summary.high}</h3>
            <p>High</p>
        </div>
        <div class="summary-card">
            <h3 style="color: ${severityColors.medium}">${result.summary.medium}</h3>
            <p>Medium</p>
        </div>
        <div class="summary-card">
            <h3 style="color: ${severityColors.low}">${result.summary.low}</h3>
            <p>Low</p>
        </div>
        <div class="summary-card">
            <h3 style="color: ${severityColors.info}">${result.summary.info}</h3>
            <p>Info</p>
        </div>
        <div class="summary-card">
            <h3>${result.summary.total}</h3>
            <p>Total</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Vulnerabilities (${result.summary.total})</h2>
        ${vulnerabilitiesHTML || '<p style="color: #6b7280;">No vulnerabilities found.</p>'}
    </div>
    
    ${result.headersResult ? `
    <div class="section">
        <h2>Security Headers Analysis</h2>
        <p><strong>Score:</strong> ${result.headersResult.data.score}/100 (Grade: ${result.headersResult.data.grade})</p>
        <p><strong>Missing Required Headers:</strong> ${result.headersResult.data.missingRequired.join(', ') || 'None'}</p>
    </div>
    ` : ''}
    
    ${result.dirbusterResult ? `
    <div class="section">
        <h2>Directory Discovery</h2>
        <p><strong>Paths Scanned:</strong> ${result.dirbusterResult.data.scanned}</p>
        <p><strong>Paths Found:</strong> ${result.dirbusterResult.data.found.length}</p>
        ${result.dirbusterResult.data.found.length > 0 ? `
        <ul>
            ${result.dirbusterResult.data.found.slice(0, 20).map(f => 
                `<li><a href="${escapeHtml(f.url)}" target="_blank">${escapeHtml(f.path)}</a> (${f.statusCode})</li>`
            ).join('')}
            ${result.dirbusterResult.data.found.length > 20 ? `<li>...and ${result.dirbusterResult.data.found.length - 20} more</li>` : ''}
        </ul>
        ` : ''}
    </div>
    ` : ''}
    
    <div class="section">
        <h2>Scan Information</h2>
        <table style="width: 100%;">
            <tr><td><strong>Target</strong></td><td>${escapeHtml(result.target)}</td></tr>
            <tr><td><strong>Start Time</strong></td><td>${result.startTime.toISOString()}</td></tr>
            <tr><td><strong>End Time</strong></td><td>${result.endTime.toISOString()}</td></tr>
            <tr><td><strong>Duration</strong></td><td>${(result.duration / 1000).toFixed(1)} seconds</td></tr>
        </table>
    </div>
    
    <footer style="text-align: center; color: #6b7280; padding: 20px;">
        Generated by STRIX Web Application Scanner
    </footer>
</body>
</html>
    `;
}

function escapeHtml(str: string): string {
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}

export default {
    scanWebApp,
    quickWebAppScan,
    fullWebAppScan,
    generateReport
};
