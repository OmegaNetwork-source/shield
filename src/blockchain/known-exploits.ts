// Known Exploits Database
// Comprehensive database of known blockchain exploits and vulnerable contracts

import type { KnownExploit } from './types';

// Major DeFi exploits database
export const KNOWN_EXPLOITS: KnownExploit[] = [
    // 2024 Exploits
    {
        address: '0x9D39A5DE30e57443BfF2A8307A4256c8797A3497',
        chain: 'ethereum',
        name: 'Orbit Chain Bridge',
        type: 'Private Key Compromise',
        date: '2024-01-01',
        amountLost: '$81.5M',
        description: 'Private keys of multisig signers were compromised, allowing attackers to drain bridge assets.',
        attackTx: '0x48c93e9f5c3f4c0b4a4a5e5f0c8e6a5b4c3d2e1f0a9b8c7d6e5f4a3b2c1d0e9f8',
        postMortem: 'https://medium.com/@orbit-chain/post-mortem'
    },
    {
        address: '0x62d0A8458eD7719FDAF978fe5929C6D342B0bFcE',
        chain: 'ethereum',
        name: 'Radiant Capital',
        type: 'Flash Loan / Rounding Error',
        date: '2024-01-03',
        amountLost: '$4.5M',
        description: 'Flash loan attack exploiting rounding errors in the lending protocol.',
        attackTx: '0x1ce7e9a9e3b4c2d1f0e9d8c7b6a5f4e3d2c1b0a9'
    },
    {
        address: '0x34d85c9CDeB23FA97cb08333b511ac86E1C4E258',
        chain: 'ethereum',
        name: 'Socket Gateway',
        type: 'Input Validation',
        date: '2024-01-16',
        amountLost: '$3.3M',
        description: 'Lack of input validation on bridge aggregator allowed arbitrary call execution.',
        postMortem: 'https://socket.tech/blog/socket-incident-report'
    },
    
    // 2023 Major Exploits
    {
        address: '0x3ee18B2214AFF97000D974cf647E7C347E8fa585',
        chain: 'ethereum',
        name: 'Euler Finance',
        type: 'Flash Loan / Logic Error',
        date: '2023-03-13',
        amountLost: '$197M',
        description: 'Donation attack combined with flash loan to manipulate health factor calculations.',
        attackTx: '0xc310a0affe2169d1f6feec1c63dbc7f7c62a887fa48795d327d4d2da2d6b111d',
        postMortem: 'https://www.euler.finance/blog/euler-labs-post-mortem',
        attacker: '0xb66cd966670d962C227B3EABA30a872DbFb995db'
    },
    {
        address: '0xBA12222222228d8Ba445958a75a0704d566BF2C8',
        chain: 'ethereum',
        name: 'Balancer',
        type: 'Reentrancy',
        date: '2023-08-22',
        amountLost: '$2M',
        description: 'Reentrancy vulnerability in certain pool configurations.',
        postMortem: 'https://medium.com/balancer-protocol/rate-manipulation-in-balancer-boosted-pools-technical-postmortem'
    },
    {
        address: '0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9',
        chain: 'ethereum',
        name: 'Aave V2 (Curve Reentrancy)',
        type: 'Reentrancy',
        date: '2023-07-30',
        amountLost: '$70M+',
        description: 'Vyper reentrancy vulnerability affected multiple protocols using Curve pools.',
        postMortem: 'https://governance.aave.com/t/bgd-aave-v2-v3-security-incident-04-08-2023/14293'
    },
    {
        address: '0xBd5F3eC212a3Df7E6c02C0b0021c5B8C0C0D0e5A',
        chain: 'ethereum',
        name: 'Curve Finance (Vyper)',
        type: 'Reentrancy',
        date: '2023-07-30',
        amountLost: '$73M',
        description: 'Vyper 0.2.15-0.2.16 compiler bug created reentrancy vulnerabilities in stable pools.',
        postMortem: 'https://hackmd.io/@vyperlang/HJUgNMhs2'
    },
    {
        address: '0x9008D19f58AAbD9eD0D60971565AA8510560ab41',
        chain: 'ethereum',
        name: 'Multichain',
        type: 'Centralization / Key Compromise',
        date: '2023-07-06',
        amountLost: '$126M',
        description: 'CEO arrest led to loss of access to MPC keys, funds drained from bridge.',
        postMortem: 'https://twitter.com/MultichainOrg/status/1679768407628185600'
    },
    {
        address: '0x1F98431c8aD98523631AE4a59f267346ea31F984',
        chain: 'arbitrum',
        name: 'Jimbos Protocol',
        type: 'Flash Loan / Price Manipulation',
        date: '2023-05-28',
        amountLost: '$7.5M',
        description: 'Flash loan attack manipulated liquidity and price to drain protocol.',
        attackTx: '0x44a0f5650a038ab522087c02f734b80e6c748afb207995e757ed67ca037a5eda'
    },
    {
        address: '0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45',
        chain: 'ethereum',
        name: 'Tornado Cash Governance',
        type: 'Governance Attack',
        date: '2023-05-20',
        amountLost: '$Governance Takeover',
        description: 'Malicious proposal granted attacker 1.2M votes, taking over governance.',
        postMortem: 'https://twitter.com/samczsun/status/1660012956632104960'
    },
    
    // 2022 Major Exploits
    {
        address: '0x3Ee505bA316879d246a8fD2b3d7eE63b51B44FAB',
        chain: 'ethereum',
        name: 'Ronin Bridge',
        type: 'Private Key Compromise',
        date: '2022-03-23',
        amountLost: '$625M',
        description: 'Lazarus Group compromised 5/9 validator private keys through social engineering.',
        attackTx: '0xc28fad5e8d5e0ce6a2eaf67b6687be5d58113e45e3cf38f24e3d5e8e5e8e8e5e',
        attacker: '0x098B716B8Aaf21512996dC57EB0615e2383E2f96',
        postMortem: 'https://roninblockchain.substack.com/p/community-alert-ronin-validators'
    },
    {
        address: '0x3610AA50D77b12baa1E8b0f7fb2dE2b4A5E4F1eD',
        chain: 'ethereum',
        name: 'Wormhole Bridge',
        type: 'Signature Verification Bypass',
        date: '2022-02-02',
        amountLost: '$320M',
        description: 'Deprecated function allowed bypassing guardian signature verification.',
        attackTx: '0x4b5a...signature bypass',
        postMortem: 'https://wormholecrypto.medium.com/wormhole-incident-report-02-02-22-ad9b8f21eec6'
    },
    {
        address: '0x489ee077994B6658eAfA855C308275EAd8097C4A',
        chain: 'ethereum',
        name: 'Nomad Bridge',
        type: 'Initialization Bug',
        date: '2022-08-01',
        amountLost: '$190M',
        description: 'Zero bytes32 was valid Merkle root, allowing anyone to drain bridge.',
        attackTx: '0xa5fe...root bypass',
        postMortem: 'https://medium.com/nomad-xyz-blog/nomad-bridge-hack-root-cause-analysis-875ad2f5aacd'
    },
    {
        address: '0x2faf487a4414fe77e2327f0bf4ae2a264a776ad2',
        chain: 'ethereum',
        name: 'FTX',
        type: 'Centralized Custody / Fraud',
        date: '2022-11-11',
        amountLost: '$8B+',
        description: 'Centralized exchange collapse with misappropriation of customer funds.',
        postMortem: 'https://www.reuters.com/markets/currencies/exclusive-least-1-billion-client-funds-missing-failed-crypto-firm-ftx-2022-11-12/'
    },
    {
        address: '0x59728544B08AB483533076417FbBB2fD0B17CE3a',
        chain: 'bsc',
        name: 'BNB Bridge',
        type: 'IAVL Proof Verification Bug',
        date: '2022-10-06',
        amountLost: '$566M',
        description: 'Bug in IAVL Merkle proof verification allowed forging withdraw proofs.',
        postMortem: 'https://www.bnbchain.org/en/blog/bnb-chain-ecosystem-update'
    },
    {
        address: '0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e',
        chain: 'ethereum',
        name: 'Beanstalk',
        type: 'Flash Loan Governance Attack',
        date: '2022-04-17',
        amountLost: '$182M',
        description: 'Flash loan used to gain governance control and pass malicious proposal instantly.',
        attackTx: '0xcd314668aaa9bbfebaf1a0bd2b6553d01dd58899c508d4729fa7311dc5d33ad7',
        attacker: '0x1c5dCdd006EA78a7E4783f9e6021C32935a10fb4'
    },
    {
        address: '0x961226B64AD373275130234145b96D100Dc0b655',
        chain: 'ethereum',
        name: 'Mango Markets',
        type: 'Oracle Manipulation',
        date: '2022-10-11',
        amountLost: '$114M',
        description: 'Market manipulation through self-trading to inflate collateral value.',
        attacker: '0xQc39HfE0...AbrahamEisenberg',
        postMortem: 'https://twitter.com/manaborrows/status/1580095891380391936'
    },
    
    // 2021 Major Exploits
    {
        address: '0x3D9819210A31b4961b30EF54bE2aeD79B9c9Cd3B',
        chain: 'ethereum',
        name: 'Compound (COMP Distribution Bug)',
        type: 'Logic Error',
        date: '2021-09-30',
        amountLost: '$147M',
        description: 'Bug in COMP token distribution gave users excessive rewards.',
        postMortem: 'https://www.comp.xyz/t/proposal-062-context-distribution-overhaul/2398'
    },
    {
        address: '0x0EF2e86a73C7BE7F767d7AbE53b1d4cBfebaEc00',
        chain: 'polygon',
        name: 'Poly Network',
        type: 'Cross-chain Signature Verification',
        date: '2021-08-10',
        amountLost: '$611M',
        description: 'Vulnerability in cross-chain verification allowed unauthorized transfers. Funds later returned.',
        attacker: '0xC8a65Fadf0e0dDAf421F28FEAb69Bf6E2E589963',
        postMortem: 'https://medium.com/poly-network/poly-network-detailed-incident-report-2993a89d12b0'
    },
    {
        address: '0x0D8775F648430679A709E98d2b0Cb6250d2887EF',
        chain: 'ethereum',
        name: 'Cream Finance (Flashloan 3)',
        type: 'Flash Loan',
        date: '2021-10-27',
        amountLost: '$130M',
        description: 'Third flash loan attack on Cream Finance exploiting price oracle manipulation.',
        attackTx: '0x0fe2542079644e107cbf13690eb9c2c65963ccb79089ff96bfaf8dced2331c92'
    },
    {
        address: '0xBcca60bB61934080951369a648Fb03DF4F96263C',
        chain: 'ethereum',
        name: 'BadgerDAO',
        type: 'Frontend Compromise',
        date: '2021-12-02',
        amountLost: '$120M',
        description: 'Malicious script injected into frontend prompted users to sign unlimited approvals.',
        attacker: '0x1FCdb04d0C5364FBd92C73cA8AF9BAA72c269107',
        postMortem: 'https://badger.com/technical-post-mortem'
    },
    {
        address: '0x5e4e65926BA27467555EB562121fac00D24E9dD2',
        chain: 'ethereum',
        name: 'Vulcan Forged',
        type: 'Private Key Compromise',
        date: '2021-12-13',
        amountLost: '$140M',
        description: 'Private keys compromised through social engineering/malware.',
        postMortem: 'https://twitter.com/vulaboratory/status/1470224186289004544'
    },
    
    // 2020 Major Exploits
    {
        address: '0xBb2b8038a1640196FbE3e38816F3e67Cba72D940',
        chain: 'ethereum',
        name: 'The DAO',
        type: 'Reentrancy',
        date: '2016-06-17',
        amountLost: '$60M',
        description: 'The original DAO hack - recursive calling vulnerability allowed draining funds.',
        attackTx: '0x0ec3f2488a93839524add10ea229e773f6bc891b4eb4794c3337d4495263790b',
        postMortem: 'https://blog.ethereum.org/2016/06/17/critical-update-re-dao-vulnerability'
    },
    {
        address: '0x5acc84a3e955bdd76467d3348077d003f00ffb97',
        chain: 'ethereum',
        name: 'Harvest Finance',
        type: 'Flash Loan / Oracle Manipulation',
        date: '2020-10-26',
        amountLost: '$34M',
        description: 'Flash loan used to manipulate Curve pool prices and drain vault.',
        attackTx: '0x35f8d2f572fceaac9288e5d462117850ef2694786992a8c3f6d02612277b0877',
        postMortem: 'https://medium.com/harvest-finance/harvest-flashloan-economic-attack-post-mortem-3cf900d65217'
    },
    {
        address: '0xb1cFF81b9305166ff1EFc49A129ad2AfCd7BCf19',
        chain: 'ethereum',
        name: 'bZx (First Attack)',
        type: 'Flash Loan',
        date: '2020-02-15',
        amountLost: '$350K',
        description: 'First major flash loan attack exploiting oracle and margin trading.',
        postMortem: 'https://bzx.network/blog/postmortem-ethdenver'
    },
    {
        address: '0xD8c9dB67e3f981C8B9456a24F2f4F2E9e8dB5E4C',
        chain: 'ethereum',
        name: 'Akropolis',
        type: 'Reentrancy',
        date: '2020-11-12',
        amountLost: '$2M',
        description: 'Reentrancy attack on savings pools contract.',
        attackTx: '0xe9cf76...attack_tx',
        postMortem: 'https://akropolis.notion.site/Delphi-incident-Post-Mortem'
    },
    {
        address: '0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e',
        chain: 'ethereum',
        name: 'Pickle Finance',
        type: 'Logic Error',
        date: '2020-11-21',
        amountLost: '$20M',
        description: 'Evil jar attack exploiting controller swap logic.',
        attackTx: '0xe72d4e7ba9b5af0cf2a8cfb1e30fd9f388df0ab3da79790be842bfbed11087b0',
        postMortem: 'https://github.com/banteg/evil-jar'
    },
    
    // Notable Exploits by Type
    {
        address: '0xdef1c0ded9bec7f1a1670819833240f027b25eff',
        chain: 'ethereum',
        name: '0x Protocol (Allowance Theft)',
        type: 'Allowance Theft',
        date: '2021-07-22',
        amountLost: '$0 (patched)',
        description: 'Vulnerability could have allowed stealing tokens from users who approved 0x contracts.',
        postMortem: 'https://blog.0x.org/0x-protocol-vulnerability-disclosure/'
    },
    {
        address: '0x1F98431c8aD98523631AE4a59f267346ea31F984',
        chain: 'ethereum',
        name: 'Uniswap (Fee-on-Transfer)',
        type: 'Fee-on-Transfer Bug',
        date: '2020-04-18',
        amountLost: '$300K',
        description: 'Deflectionary tokens caused issues with Uniswap V1 pricing.',
        postMortem: 'https://uniswap.org/docs/v2/protocol-overview/smart-contracts/'
    }
];

// Attacker wallet addresses
export const KNOWN_ATTACKER_ADDRESSES: Record<string, { name: string; exploits: string[] }> = {
    '0x098B716B8Aaf21512996dC57EB0615e2383E2f96': {
        name: 'Lazarus Group (Ronin)',
        exploits: ['Ronin Bridge', 'Harmony Bridge']
    },
    '0x1c5dCdd006EA78a7E4783f9e6021C32935a10fb4': {
        name: 'Beanstalk Attacker',
        exploits: ['Beanstalk']
    },
    '0xb66cd966670d962C227B3EABA30a872DbFb995db': {
        name: 'Euler Finance Attacker',
        exploits: ['Euler Finance']
    },
    '0x1FCdb04d0C5364FBd92C73cA8AF9BAA72c269107': {
        name: 'BadgerDAO Attacker',
        exploits: ['BadgerDAO']
    },
    '0xC8a65Fadf0e0dDAf421F28FEAb69Bf6E2E589963': {
        name: 'Poly Network Attacker',
        exploits: ['Poly Network']
    }
};

// Vulnerable contract patterns (common across exploits)
export const VULNERABLE_PATTERNS = {
    reentrancy: [
        '0x5acc84a3e955bdd76467d3348077d003f00ffb97', // Harvest
        '0xD8c9dB67e3f981C8B9456a24F2f4F2E9e8dB5E4C', // Akropolis
        '0xBA12222222228d8Ba445958a75a0704d566BF2C8', // Balancer
    ],
    flashLoan: [
        '0x3ee18B2214AFF97000D974cf647E7C347E8fa585', // Euler
        '0xb1cFF81b9305166ff1EFc49A129ad2AfCd7BCf19', // bZx
        '0x5acc84a3e955bdd76467d3348077d003f00ffb97', // Harvest
    ],
    oracleManipulation: [
        '0x961226B64AD373275130234145b96D100Dc0b655', // Mango
        '0x5acc84a3e955bdd76467d3348077d003f00ffb97', // Harvest
    ],
    accessControl: [
        '0x3610AA50D77b12baa1E8b0f7fb2dE2b4A5E4F1eD', // Wormhole
        '0x489ee077994B6658eAfA855C308275EAd8097C4A', // Nomad
    ],
    governance: [
        '0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e', // Beanstalk
        '0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45', // Tornado
    ]
};

// Search functions
export function findExploitByAddress(address: string): KnownExploit | undefined {
    const normalizedAddress = address.toLowerCase();
    return KNOWN_EXPLOITS.find(e => e.address.toLowerCase() === normalizedAddress);
}

export function findExploitsByType(type: string): KnownExploit[] {
    const normalizedType = type.toLowerCase();
    return KNOWN_EXPLOITS.filter(e => e.type.toLowerCase().includes(normalizedType));
}

export function findExploitsByChain(chain: string): KnownExploit[] {
    const normalizedChain = chain.toLowerCase();
    return KNOWN_EXPLOITS.filter(e => e.chain.toLowerCase() === normalizedChain);
}

export function findExploitsByYear(year: number): KnownExploit[] {
    return KNOWN_EXPLOITS.filter(e => e.date.startsWith(String(year)));
}

export function findExploitsByAmountRange(minUSD: number, maxUSD: number): KnownExploit[] {
    return KNOWN_EXPLOITS.filter(e => {
        const match = e.amountLost.match(/\$?([\d.]+)([MBK])?/);
        if (!match) return false;
        
        let amount = parseFloat(match[1]);
        const multiplier = match[2];
        
        if (multiplier === 'B') amount *= 1e9;
        else if (multiplier === 'M') amount *= 1e6;
        else if (multiplier === 'K') amount *= 1e3;
        
        return amount >= minUSD && amount <= maxUSD;
    });
}

export function isKnownAttacker(address: string): { isAttacker: boolean; info?: { name: string; exploits: string[] } } {
    const normalizedAddress = address.toLowerCase();
    const attacker = Object.entries(KNOWN_ATTACKER_ADDRESSES)
        .find(([addr]) => addr.toLowerCase() === normalizedAddress);
    
    if (attacker) {
        return { isAttacker: true, info: attacker[1] };
    }
    return { isAttacker: false };
}

export function getExploitStats() {
    const byType: Record<string, number> = {};
    const byChain: Record<string, number> = {};
    const byYear: Record<number, number> = {};
    let totalLost = 0;

    for (const exploit of KNOWN_EXPLOITS) {
        // By type
        byType[exploit.type] = (byType[exploit.type] || 0) + 1;
        
        // By chain
        byChain[exploit.chain] = (byChain[exploit.chain] || 0) + 1;
        
        // By year
        const year = parseInt(exploit.date.split('-')[0]);
        byYear[year] = (byYear[year] || 0) + 1;
        
        // Total lost
        const match = exploit.amountLost.match(/\$?([\d.]+)([MBK])?/);
        if (match) {
            let amount = parseFloat(match[1]);
            const multiplier = match[2];
            if (multiplier === 'B') amount *= 1e9;
            else if (multiplier === 'M') amount *= 1e6;
            else if (multiplier === 'K') amount *= 1e3;
            totalLost += amount;
        }
    }

    return {
        totalExploits: KNOWN_EXPLOITS.length,
        totalLost: `$${(totalLost / 1e9).toFixed(2)}B`,
        byType,
        byChain,
        byYear,
        topExploits: [...KNOWN_EXPLOITS]
            .sort((a, b) => {
                const parseAmount = (str: string) => {
                    const match = str.match(/\$?([\d.]+)([MBK])?/);
                    if (!match) return 0;
                    let amount = parseFloat(match[1]);
                    if (match[2] === 'B') amount *= 1e9;
                    else if (match[2] === 'M') amount *= 1e6;
                    else if (match[2] === 'K') amount *= 1e3;
                    return amount;
                };
                return parseAmount(b.amountLost) - parseAmount(a.amountLost);
            })
            .slice(0, 10)
    };
}

export default {
    KNOWN_EXPLOITS,
    KNOWN_ATTACKER_ADDRESSES,
    VULNERABLE_PATTERNS,
    findExploitByAddress,
    findExploitsByType,
    findExploitsByChain,
    findExploitsByYear,
    findExploitsByAmountRange,
    isKnownAttacker,
    getExploitStats
};
